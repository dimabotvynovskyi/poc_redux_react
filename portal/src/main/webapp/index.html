<!DOCTYPE html>
<html>
<head>
    <title>Require, react, redux</title>
    <script src="https://fb.me/react-0.14.7.js"></script>
    <script src="https://fb.me/react-dom-0.14.7.js"></script>
    <script src="js/lib/jquery-2.2.1.min.js"></script>
    <script src="js/lib/redux.min.js"></script>
    <script src="js/lib/redux-thunk.js"></script>
    <script src="js/lib/require.js"></script>
    <script src="js/components.js"></script>

    <link rel="stylesheet" type="text/css" href="/portal/css/app.css">
</head>
<body>

<div id="sideNav"></div>
<div id="viewContainer"></div>


<script>
    require.config({
        baseUrl: "/portal/js",
        paths: {
            'plugin1.init': '/plugin1/define',
            'plugin2.init': '/plugin2/define',
            'plugin3.init': '/plugin3/define'
        }
    });

    var navItems = [];

    define("global.nav.items", [], function () {
        return navItems;
    });

    define("portal.reducers.map", ["reducers"], function (reducers) {
        return {
            counter: reducers.counterReducer,
            persons: reducers.personsReducer
        }
    });




    require([
        "global.nav.items",
        "plugin1.init",
        "plugin2.init",
        "plugin3.init"
    ], function (navItems) {
        define("global.store", ["portal.reducers.map", "plugin1.reducers.map"], function (portalReducersMap, plugin1ReducersMap) {
            /* Create store */
            return Redux.createStore(
                    Redux.combineReducers($.extend({}, portalReducersMap, plugin1ReducersMap)),
                    Redux.applyMiddleware(
                            thunkMiddleware
                    )
            );
        });

        define("global.view.manager", ["global.store"], function (store) {
            var previousListener;

            return {
                render: function (viewName) {
                    require([viewName], function (view) {
                        if (previousListener) {
                            previousListener();
                        }

                        function renderNextView() {
                            ReactDOM.unmountComponentAtNode(document.getElementById('viewContainer'));
                            ReactDOM.render(React.createElement(view, {store: store}), document.getElementById('viewContainer'));
                        }

                        renderNextView();
                        previousListener = store.subscribe(renderNextView);
                    });
                }
            }
        });

        require(["global.store", "global.view.manager"], function (store, viewManager) {
            ReactDOM.render(React.createElement(NavBar, {viewManager: viewManager, navItems: navItems}), document.getElementById('sideNav'));
            console.log("Portal, plugins and store have initialized!");

            /* sync actions (return an object) */
            function incrementCounterAction() {
                return {
                    type: 'INCREMENT'
                }
            }

            function decrementCounterAction() {
                return {
                    type: 'DECREMENT'
                }
            }

            function requestPersons() {
                return {
                    type: "REQUEST_PERSONS_LIST"
                };
            }

            function receivePersons(json) {
                return {
                    type: "RECEIVE_PERSONS_LIST",
                    items: json
                };
            }
            /* sync actions */

            /* Async actions (return function) */
            function fetchPersons() {
                return function (dispatch) {
                    dispatch(requestPersons());

                    return $.get("/portal/data.json", function (json) {
                        console.log("Fetching finished" + json);
                        dispatch(receivePersons(json))
                    });
                }
            }
            /* Async actions */

            /* Render */
            function render() {
                ReactDOM.render(
                        React.createElement("div", null,
                                React.createElement(Counter, {
                                    "value": store.getState().counter,
                                    "onIncrement": function() {store.dispatch(incrementCounterAction());},
                                    "onDecrement": function() {store.dispatch(decrementCounterAction());}
                                }),
                                React.createElement("hr", null),
                                React.createElement(PersonList, {"persons": store.getState().persons.items}),
                                React.createElement("br", null),
                                React.createElement("button", {"onClick": function() {store.dispatch(fetchPersons());}}, "Load Persons"),
                                React.createElement("hr", null)
                        ),
                        document.getElementById('viewContainer')
                );
            }

            render();
            store.subscribe(render);



        });
    });

</script>
</body>
</html>