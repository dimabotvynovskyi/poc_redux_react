<!DOCTYPE html>
<html>
<head>
    <title>Require, react, redux</title>
    <script src="https://fb.me/react-0.14.7.js"></script>
    <script src="https://fb.me/react-dom-0.14.7.js"></script>
    <script src="js/lib/jquery-2.2.1.min.js"></script>
    <script src="js/lib/redux.min.js"></script>
    <script src="js/lib/require.js"></script>
    <script src="js/components.js"></script>

    <link rel="stylesheet" type="text/css" href="/portal/css/app.css">
</head>
<body>

<div id="root"></div>


<script>
    require.config({
        baseUrl: "/portal/js",
        paths: {
            'plugin1.init': '/plugin1/define',
            'plugin2.init': '/plugin2/define',
            'plugin3.init': '/plugin3/define'
        }
    });

    require([
        "reducers",
        "plugin1.init",
        "plugin2.init",
        "plugin3.init"
    ], function (reducers) {
        require(["plugin1.ping", "plugin2.ping", "plugin3.ping"], function () {
            console.log("Ping finished");
        });

        console.log("Portal with related plugins has initialized!");

        function thunkMiddleware(_ref) {
            var dispatch = _ref.dispatch;
            var getState = _ref.getState;

            return function (next) {
                return function (action) {
                    return typeof action === 'function' ? action(dispatch, getState) : next(action);
                };
            };
        }

        var store = Redux.createStore(
                Redux.combineReducers({
                    counter: reducers.counterReducer,
                    persons: reducers.personsReducer
                }),
                Redux.applyMiddleware(
                    thunkMiddleware
                )
        );

        function requestPersons() {
            return {
                type: "REQUEST_PERSONS_LIST"
            };
        }

        function receivePersons(json) {
            return {
                type: "RECEIVE_PERSONS_LIST",
                items: json
            };
        }

        function fetchPersons() {
            return function (dispatch) {
                dispatch(requestPersons());

                return $.get("/portal/data.json", function (json) {
                    console.log("Fetching finished" + json);
                    dispatch(receivePersons(json))
                });
            }
        }

        function render() {
            ReactDOM.render(
                    React.createElement("div", null,
                            React.createElement(Counter, {
                                "value": store.getState().counter,
                                "storeDispatch": store.dispatch
                            }),
                            React.createElement("hr", null),
                            React.createElement(PersonList, {"persons": store.getState().persons.items}),
                            React.createElement("br", null),
                            React.createElement("button", {"onClick": function() {store.dispatch(fetchPersons());}}, "Load Persons"),
                            React.createElement("hr", null)
                    ),
                    document.getElementById('root')
            );
        }

        render();
        store.subscribe(render);
    });

</script>
</body>
</html>